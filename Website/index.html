<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">🌍 Where is my kid? 🌍</title>
    <link rel="icon" type="image/png" href="imagenes/favicon.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/indexstyle.css">
</head>
<body>
    <video autoplay loop muted id="background-video">
        <source src="./Videos/Fondoindex.mp4" type="video/mp4">
        Tu navegador no soporta videos, por favor prueba en otro navegador :D.
    </video>

    <header>
        <div class="menu-left">
            <h1>Where is my kid? 🧒🏻🌍</h1>
        </div>
        <nav class="menu-right" id="nav-menu">
            <a href="Map.html" class="menu-option">Ir al mapa</a>
        </nav>
    </header>

    <div class="cloud-container">
        <div class="cloud">
            <h2>¿Sabías que?</h2>
        </div>
        <div class="cloud">
            <p>En España <strong>el 16% de los atropellos al año son a menores de 14 años</strong>, eso son <strong>1540 niños al año.</strong></p>
        </div>
        <div class="cloud">
            <p>Un estudio realizado en Andalucía indica que <strong>el 34,6% de los accidentes infantiles ocurren en la calle por ir desatendidos o solos.</strong></p>
        </div>
        <div class="cloud">
            <p>Los <strong>secuestros de menores</strong> con fines criminales en España <strong>aumentaron un 125% de 2023 a 2024</strong>, pasando de 8 a 18.</p>
        </div>
        <div class="cloud">
            <h4>¿Y si fuera tu hijo?</h4>
        </div>
        <div class="cloud">
            <a href="register.html">REGISTRARSE 📝</a>
        </div>
    </div>

    <footer>
        <p>© 2025 Where is my kid? | David Cela Pedraza</p>
    </footer>

    <script src="js/scripttitulo.js"></script>
    <script type="module">
        // IMPORT FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        
        // CONFIG of Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCF6ycf52hW9Ypz9Vw-OHH0LuZ2-J4t6sM",
          authDomain: "ubicacion-faf91.firebaseapp.com",
          projectId: "ubicacion-faf91",
          storageBucket: "ubicacion-faf91.firebasestorage.app",
          messagingSenderId: "87507844915",
          appId: "1:87507844915:web:60039ca325721053cac846",
          measurementId: "G-29NFK6PEW3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentUserData = null;
        
        // Listen changes in the authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Logged in - get user data
                getDoc(doc(db, "usuarios", user.uid)).then((userDoc) => {
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data();
                        
                        // Update the user name in the menu
                        const userMenu = document.getElementById('user-menu');
                        if (userMenu) {
                            userMenu.textContent = currentUserData.nombre || 'Usuario';
                        } else {
                            // Create the menu if it doesn't exist
                            updateNavMenu(user);
                        }
                    }
                }).catch(error => {
                    console.error("Error al obtener datos del usuario:", error);
                });
            } else {
                // Not logged in
                updateNavMenu(null);
            }
        });
        
        /**
         * Handles changes in authentication state
         */
        function updateNavMenu(user) {
            const navMenu = document.getElementById('nav-menu');
            
            // Clean previous elements
            clearNavMenu(navMenu);
            
            if (user) {
                // Logged in - Add user menu
                addUserMenu(navMenu, user);
            } else {
                // Not logged in - Add login/register links
                addAuthLinks(navMenu);
            }
        }
        
        /**
         * Clean the navigation menu elements
         */
        function clearNavMenu(navMenu) {
            // Keep only Map (in the case of the index)
            const navItems = navMenu.querySelectorAll('a:not([href="Map.html"])');
            navItems.forEach(item => {
                if (item.parentNode === navMenu) {
                    navMenu.removeChild(item);
                }
            });
            
            // Delete existing dropdowns
            const existingDropdowns = navMenu.querySelectorAll('.dropdown');
            existingDropdowns.forEach(dropdown => {
                navMenu.removeChild(dropdown);
            });
        }
        
        /**
         * Adds the user menu with logout option
         */
        function addUserMenu(navMenu, user) {
            const userDropdown = document.createElement('div');
            userDropdown.className = 'dropdown';
            
            const userButton = document.createElement('a');
            userButton.className = 'menu-option';
            userButton.href = '#';
            userButton.id = 'user-menu';
            userButton.textContent = currentUserData?.nombre || 'Usuario';
            
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';
            
            const profileOption = document.createElement('a');
            profileOption.className = 'dropdown-option';
            profileOption.href = 'profile.html';
            profileOption.textContent = 'Mi Perfil';
            
            const logoutOption = document.createElement('a');
            logoutOption.className = 'dropdown-option';
            logoutOption.href = '#';
            logoutOption.textContent = 'Cerrar Sesión';
            logoutOption.addEventListener('click', handleLogout);
            
            dropdownContent.appendChild(profileOption);
            dropdownContent.appendChild(logoutOption);
            userDropdown.appendChild(userButton);
            userDropdown.appendChild(dropdownContent);
            navMenu.appendChild(userDropdown);
        }
        
        /**
         * Adds login and register links
         */
        function addAuthLinks(navMenu) {
            const loginLink = document.createElement('a');
            loginLink.href = 'login.html';
            loginLink.className = 'menu-option';
            loginLink.textContent = 'Iniciar Sesión';
            
            const registerLink = document.createElement('a');
            registerLink.href = 'register.html';
            registerLink.className = 'menu-option';
            registerLink.textContent = 'Registrarse';
            
            navMenu.appendChild(loginLink);
            navMenu.appendChild(registerLink);
        }
        
        /**
         * Handles logout
         */
        function handleLogout(e) {
            e.preventDefault();
            signOut(auth).then(() => {
                console.log('Sesión cerrada');
                localStorage.removeItem('dispositivoID');
                window.location.reload();
            }).catch((error) => {
                console.error('Error al cerrar sesión:', error);
            });
        }
    </script>
</body>
</html>

