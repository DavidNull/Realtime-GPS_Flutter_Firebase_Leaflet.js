<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">🌍 Where is my kid? 🌍</title>
    <link rel="icon" type="image/png" href="imagenes/favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/indexstyle.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <header>
        <div class="logo">
            <h2>Where is my kid?</h2>
        </div>
        <nav class="menu-right" id="nav-menu">
            <a href="index.html" class="menu-option">Inicio</a>
        </nav>
    </header>

    <div id="map"></div>
    
    <!-- Message for users not logged in -->
    <div id="login-message" class="map-login-message" style="display: none;">
        <h3>¿Dónde está tu hijo?</h3>
        <p>Inicia sesión para ver la ubicación de tu hijo en tiempo real</p>
        <a href="login.html" class="login-button">Iniciar Sesión</a>
    </div>
    
    <footer>
        <p>© 2025 Where is my kid? | Todos los derechos reservados</p>
    </footer>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/scripttitulo.js"></script>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCF6ycf52hW9Ypz9Vw-OHH0LuZ2-J4t6sM",
          authDomain: "ubicacion-faf91.firebaseapp.com",
          projectId: "ubicacion-faf91",
          storageBucket: "ubicacion-faf91.firebasestorage.app",
          messagingSenderId: "87507844915",
          appId: "1:87507844915:web:60039ca325721053cac846",
          measurementId: "G-29NFK6PEW3"
        };
      
        // Global variables
        let marker;
        let currentDeviceId = null;
        let unsubscribe = null;
        let currentUserData = null;
        
        // Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Initialize map
        initMap();
        
        // Listen changes in authentication
        onAuthStateChanged(auth, handleAuthChange);
        
        /**
         * Initializes the Leaflet map
         */
        function initMap() {
            const map = L.map('map', {
                zoomControl: false
            }).setView([40.416775, -3.703790], 6); // Initial view of Spain
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            // Adjust the map size when the window size changes
            window.addEventListener('resize', () => map.invalidateSize());
            
            // Make the map available globally for other functions
            window.leafletMap = map;
        }
        
        /**
         * Handles changes in authentication state
         */
        function handleAuthChange(user) {
            const loginMessage = document.getElementById('login-message');
            
            if (user) {
                // Logged in
                if (loginMessage) {
                    loginMessage.style.display = 'none';
                }
                
                getDoc(doc(db, "usuarios", user.uid))
                    .then(userDoc => {
                        if (userDoc.exists()) {
                            currentUserData = userDoc.data();
                            
                            // Update the user name in the menu
                            const userMenu = document.getElementById('user-menu');
                            if (userMenu) {
                                userMenu.textContent = currentUserData.nombre || 'Usuario';
                            } else {
                                // Create the menu if it doesn't exist
                                updateNavMenu(user);
                            }
                            
                            if (currentUserData.dispositivoID) {
                                rastrearDispositivo(currentUserData.dispositivoID);
                            }
                        }
                    })
                    .catch(error => console.error("Error al obtener datos del usuario:", error));
            } else {
                // Not logged in
                if (loginMessage) {
                    loginMessage.style.display = 'block';
                }
                
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
                
                if (marker && window.leafletMap) {
                    window.leafletMap.removeLayer(marker);
                    marker = null;
                }
                
                updateNavMenu(null);
                
                // We don't redirect the user, we only show the login message
            }
        }

        /**
         * Updates the navigation menu according to the authentication state
         */
        function updateNavMenu(user) {
            const navMenu = document.getElementById('nav-menu');
            
            // Clean previous elements
            clearNavMenu(navMenu);
            
            if (user) {
                // Logged in - Add user menu
                addUserMenu(navMenu, user);
            } else {
                // Not logged in - Add login/register links
                addAuthLinks(navMenu);
            }
        }
        
        /**
         * Clean the navigation menu elements
         */
        function clearNavMenu(navMenu) {
            // Keep only Inicio
            const navItems = navMenu.querySelectorAll('a:not([href="index.html"])');
            navItems.forEach(item => {
                if (item.parentNode === navMenu) {
                    navMenu.removeChild(item);
                }
            });
            
            // Delete existing dropdowns
            const existingDropdowns = navMenu.querySelectorAll('.dropdown');
            existingDropdowns.forEach(dropdown => {
                navMenu.removeChild(dropdown);
            });
        }
        
        /**
         * Adds the user menu with logout option
         */
        function addUserMenu(navMenu, user) {
            const userDropdown = document.createElement('div');
            userDropdown.className = 'dropdown';
            
            const userButton = document.createElement('a');
            userButton.className = 'menu-option';
            userButton.href = '#';
            userButton.id = 'user-menu';
            userButton.textContent = currentUserData?.nombre || 'Usuario';
            
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';
            
            const profileOption = document.createElement('a');
            profileOption.className = 'dropdown-option';
            profileOption.href = 'profile.html';
            profileOption.textContent = 'Mi Perfil';
            
            const logoutOption = document.createElement('a');
            logoutOption.className = 'dropdown-option';
            logoutOption.href = '#';
            logoutOption.textContent = 'Cerrar Sesión';
            logoutOption.addEventListener('click', handleLogout);
            
            dropdownContent.appendChild(profileOption);
            dropdownContent.appendChild(logoutOption);
            userDropdown.appendChild(userButton);
            userDropdown.appendChild(dropdownContent);
            navMenu.appendChild(userDropdown);
        }
        
        /**
         * Adds login and register links
         */
        function addAuthLinks(navMenu) {
            const loginLink = document.createElement('a');
            loginLink.href = 'login.html';
            loginLink.className = 'menu-option';
            loginLink.textContent = 'Iniciar Sesión';
            
            const registerLink = document.createElement('a');
            registerLink.href = 'register.html';
            registerLink.className = 'menu-option';
            registerLink.textContent = 'Registrarse';
            
            navMenu.appendChild(loginLink);
            navMenu.appendChild(registerLink);
        }
        
        /**
         * Handles logout
         */
        function handleLogout(e) {
            e.preventDefault();
            signOut(auth)
                .then(() => {
                    localStorage.removeItem('dispositivoID');
                    window.location.href = 'index.html';
                })
                .catch(error => console.error('Error al cerrar sesión:', error));
        }
        
        /**
         * Starts tracking a device by its ID
         */
        function rastrearDispositivo(deviceId) {
            // Stop previous listening if it exists
            if (unsubscribe) {
                unsubscribe();
            }
            
            // Delete previous marker if it exists
            if (marker && window.leafletMap) {
                window.leafletMap.removeLayer(marker);
                marker = null;
            }
            
            currentDeviceId = deviceId;
            
            // Start listening in Firestore
            unsubscribe = onSnapshot(doc(db, "ubicaciones", deviceId), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    if (data && data.latitud && data.longitud) {
                        const position = [data.latitud, data.longitud];
                        
                        if (!marker) {
                            // Create marker if it doesn't exist
                            marker = L.marker(position).addTo(window.leafletMap);
                            // Center map on the marker
                            window.leafletMap.setView(position, 15);
                        } else {
                            // Update marker position
                            marker.setLatLng(position);
                        }
                    }
                }
            }, (error) => {
                    console.error("Error al escuchar cambios en la ubicación:", error);
            });
        }
    </script>
</body>
</html>
